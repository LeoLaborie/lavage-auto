// ===========================================
// klyn - Prisma Schema (Story 1.1)
// ===========================================
// Conventions:
//   - Models: PascalCase singular
//   - Tables: snake_case plural via @@map
//   - Fields: camelCase, mapped to snake_case via @map
//   - Money: ALWAYS Int in cents (e.g., 25€ = 2500)
//   - Dates: DateTime (ISO 8601 in API layer)
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")  // Required for prisma migrate (bypasses PgBouncer)
}

// ========================================
// ENUMS
// ========================================

enum UserRole {
  CLIENT
  LAVEUR
  ADMIN
}

enum ProfileStatus {
  VALIDATION_PENDING
  VALIDATED
  REJECTED
}

enum BookingStatus {
  PENDING       // Booking created, awaiting payment or confirmation
  CONFIRMED     // Payment received, waiting for laveur
  ACCEPTED      // Laveur has accepted the mission
  EN_ROUTE      // Laveur is on the way
  IN_PROGRESS   // Washing in progress
  COMPLETED     // Service finished and validated by client
  CANCELLED     // Cancelled by client (>24h before) or system
}

enum PaymentStatus {
  PENDING              // Payment not yet initiated
  PROCESSING           // Stripe session created, awaiting completion
  SUCCEEDED            // Payment captured / funds held
  FAILED               // Payment attempt failed
  REFUNDED             // Full refund issued
  PARTIALLY_REFUNDED   // Partial refund issued
}

// ========================================
// CORE MODELS
// ========================================

/// Unified user entity linked to Supabase Auth.
/// Role determines access (CLIENT, LAVEUR, ADMIN) enforced via middleware.
model User {
  id        String   @id @default(cuid())
  authId    String   @unique @map("auth_id")  // Supabase Auth UUID
  email     String   @unique
  role      UserRole @default(CLIENT)

  // Relationships
  profile   Profile?
  bookingsAsClient  Booking[]  @relation("ClientBookings")
  bookingsAsLaveur  Booking[]  @relation("LaveurBookings")
  payments  Payment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@map("users")
}

/// Extended profile information.
/// For Laveurs: stores SIRET, validation status, and Stripe Connect account.
model Profile {
  id        String   @id @default(cuid())

  userId    String   @unique @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Common fields
  firstName       String?  @map("first_name")
  lastName        String?  @map("last_name")
  phone           String?  @map("phone")
  avatarUrl       String?  @map("avatar_url")

  // Laveur-specific fields
  siret           String?  @unique @map("siret")   // SIRET for professional verification (14 digits)
  companyName     String?  @map("company_name")
  status          ProfileStatus  @map("status")    // Set explicitly: VALIDATED for Clients, VALIDATION_PENDING for Laveurs
  stripeAccountId String?  @unique @map("stripe_account_id")  // Stripe Connect

  // Laveur work preferences
  workRadius      Float?   @map("work_radius")   // Service radius in km
  workAddress     String?  @map("work_address")   // Base location

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@map("profiles")
}

/// A booking represents a single car wash reservation.
/// Lifecycle: PENDING -> CONFIRMED -> ACCEPTED -> EN_ROUTE -> IN_PROGRESS -> COMPLETED
model Booking {
  id        String   @id @default(cuid())

  // Client who made the booking
  clientId  String   @map("client_id")
  client    User     @relation("ClientBookings", fields: [clientId], references: [id], onDelete: Cascade)

  // Laveur assigned to the mission (nullable until accepted)
  laveurId  String?  @map("laveur_id")
  laveur    User?    @relation("LaveurBookings", fields: [laveurId], references: [id])

  // Service details
  serviceName     String  @map("service_name")    // e.g. "Lavage Basique", "Lavage Premium"
  amountCents     Int     @map("amount_cents")     // Price in cents (e.g., 2500 = 25€)
  currency        String  @default("EUR") @map("currency")

  // Scheduling
  scheduledDate   DateTime @map("scheduled_date")  // Date + time of the appointment
  status          BookingStatus @default(PENDING)

  // Location
  serviceAddress  String   @map("service_address")
  serviceLat      Float?   @map("service_lat")
  serviceLng      Float?   @map("service_lng")
  accessNotes     String?  @map("access_notes")     // Parking, gate codes, etc.

  // Photos (Supabase Storage URLs)
  beforePhotoUrl  String?  @map("before_photo_url")
  afterPhotoUrl   String?  @map("after_photo_url")

  // Cancellation
  cancelledAt     DateTime? @map("cancelled_at")
  cancellationReason String? @map("cancellation_reason")

  // Completion
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  validatedAt     DateTime? @map("validated_at")    // When client validated the job

  // Relationships
  payment Payment?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([clientId, status])
  @@index([laveurId, status])
  @@index([status])
  @@map("bookings")
}

/// Payment record linked to a Booking, tracking Stripe transactions.
/// All amounts stored in cents (Int).
model Payment {
  id        String   @id @default(cuid())

  bookingId String   @unique @map("booking_id")
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Payer
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])

  // Financial
  amountCents     Int          @map("amount_cents")    // Amount in cents
  currency        String       @default("EUR") @map("currency")
  status          PaymentStatus @default(PENDING) @map("status")

  // Stripe references
  stripeSessionId   String?  @unique @map("stripe_session_id")    // Checkout Session ID
  stripePaymentIntentId String? @unique @map("stripe_payment_intent_id")
  stripeTransferId  String?  @unique @map("stripe_transfer_id")   // Payout transfer to Laveur

  // Refund tracking
  refundAmountCents Int?     @map("refund_amount_cents")
  refundedAt        DateTime? @map("refunded_at")
  refundReason      String?  @map("refund_reason")

  // Payout tracking
  paidOutAt         DateTime? @map("paid_out_at")     // When funds were transferred to Laveur

  processedAt       DateTime? @map("processed_at")    // When payment was confirmed

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([userId])
  @@map("payments")
}
